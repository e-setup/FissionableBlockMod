<pe:mcml>
<script type="text/npl" refresh="true">
<![CDATA[

    NPL.load("(gl)Mod/fissionable_block/ItemFissionable.lua");
    FissionContext = commonlib.gettable("Mod.FissionableBlock.FissionContext");
    local status = FissionContext:GetCurrentBlockStatus();
    local color = {r=255,b=255,g=255}
    if(status) then
        color = status.color; -- template_id本应也在此做默认值恢复。但在这里设置没有生效，所以在FissionContext:ShowPropertyPage(status)里设置
    end
    
    local template_id = -1;

    function hidepage(name)
        --_guihelper.MessageBox(string.format("current choise:%d\n",Page("#tex_type"):GetValue()));
        local type = Page:GetUIValue("tex_type");
        if(tonumber(type) == 1) then
            template_id = Page("#texture"):GetValue();
            color = {r=255,b=255,g=255}
            --_guihelper.MessageBox(template_id);
        end
        FissionContext:SetProperty({color=color,template_id=tonumber(template_id)});
        FissionContext:ClosePropertyPage();
        Page:Close();
    end

    function ColorChanged(r,g,b)
        if(r and g and b) then
            color = {r=r,g=g,b=b}
            Page:SetValue("tex_type","0");
            template_id = -1;
        end
    end

    function TextureChanged(name)
        template_id = Page("#"..name):GetValue();
        Page:SetValue("tex_type","1");
        color = {r=255,g=255,b=255}
        --_guihelper.MessageBox(template_id);
    end

    function OnTypeChange(name)
        local type = Page:GetUIValue("tex_type");
        if(type == 1) then
            template_id = Page("#texture"):GetValue();
            _guihelper.MessageBox(template_id);
        end
    end

    Page:SetNodeValue("blockcolor",FissionContext:GetCurrentColor());

    print("Page:SetNodeValue color")
    echo(color)

    ]]>
</script>
<aries:window mode="thin" style='width:250px;height:250px;color:#ffffff;' title='<%=L"可分裂方块属性" %>'>
    <div style="margin:10px;width:230px">
        <div><input type="radio" checked="checked" onclick="OnTypeChange()" style="margin:2px" name="tex_type" id="color" value="0"/><div style="float:left;" for="color"><%=L"颜色"%></div></div>
        <pe:colorpicker name="blockcolor" version="1" style="width:180px;" onchange="ColorChanged()"/>
    </div>
    <hr />
    <div style="margin:10px;width:230px">
        <div><input type="radio" style="margin:2px" onclick="OnTypeChange()" name="tex_type" id="material" value="1"/><div style="float:left;" for="material"><%=L"材质"%></div></div>
        <select name="texture" onselect="TextureChanged()" AllowUserEdit="false" class="mc_text" DataSource='<%=FissionContext.GetTextureList()%>' style="width:200px;height:30px;"/>
    </div>
    <div style="margin:10px;width:230px">
        <input type="button" name="okButton" style="margin-left:60px;width:100px;height:30px;color:#ffffff;" value="确定" class="mc_small_button" onclick="hidepage()"/>
    </div>
</aries:window>
</pe:mcml>
